"use strict";(self.webpackChunkfigment_documentation=self.webpackChunkfigment_documentation||[]).push([[419],{5162:(e,t,n)=>{n.d(t,{Z:()=>o});var a=n(7294),r=n(6010);const s="tabItem_Ymn6";function o(e){let{children:t,hidden:n,className:o}=e;return a.createElement("div",{role:"tabpanel",className:(0,r.Z)(s,o),hidden:n},t)}},5488:(e,t,n)=>{n.d(t,{Z:()=>h});var a=n(7462),r=n(7294),s=n(6010),o=n(2389),i=n(7392),l=n(7094),d=n(2466);const u="tabList__CuJ",c="tabItem_LNqP";function p(e){const{lazy:t,block:n,defaultValue:o,values:p,groupId:h,className:m}=e,k=r.Children.map(e.children,(e=>{if((0,r.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})),g=p??k.map((e=>{let{props:{value:t,label:n,attributes:a}}=e;return{value:t,label:n,attributes:a}})),w=(0,i.l)(g,((e,t)=>e.value===t.value));if(w.length>0)throw new Error(`Docusaurus error: Duplicate values "${w.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`);const v=null===o?o:o??k.find((e=>e.props.default))?.props.value??k[0].props.value;if(null!==v&&!g.some((e=>e.value===v)))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${v}" but none of its children has the corresponding value. Available values are: ${g.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);const{tabGroupChoices:f,setTabGroupChoices:b}=(0,l.U)(),[y,N]=(0,r.useState)(v),C=[],{blockElementScrollPositionUntilNextRender:q}=(0,d.o5)();if(null!=h){const e=f[h];null!=e&&e!==y&&g.some((t=>t.value===e))&&N(e)}const T=e=>{const t=e.currentTarget,n=C.indexOf(t),a=g[n].value;a!==y&&(q(t),N(a),null!=h&&b(h,String(a)))},S=e=>{let t=null;switch(e.key){case"Enter":T(e);break;case"ArrowRight":{const n=C.indexOf(e.currentTarget)+1;t=C[n]??C[0];break}case"ArrowLeft":{const n=C.indexOf(e.currentTarget)-1;t=C[n]??C[C.length-1];break}}t?.focus()};return r.createElement("div",{className:(0,s.Z)("tabs-container",u)},r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,s.Z)("tabs",{"tabs--block":n},m)},g.map((e=>{let{value:t,label:n,attributes:o}=e;return r.createElement("li",(0,a.Z)({role:"tab",tabIndex:y===t?0:-1,"aria-selected":y===t,key:t,ref:e=>C.push(e),onKeyDown:S,onClick:T},o,{className:(0,s.Z)("tabs__item",c,o?.className,{"tabs__item--active":y===t})}),n??t)}))),t?(0,r.cloneElement)(k.filter((e=>e.props.value===y))[0],{className:"margin-top--md"}):r.createElement("div",{className:"margin-top--md"},k.map(((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==y})))))}function h(e){const t=(0,o.Z)();return r.createElement(p,(0,a.Z)({key:String(t)},e))}},4845:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>y,contentTitle:()=>f,default:()=>q,frontMatter:()=>v,metadata:()=>b,toc:()=>N});var a=n(7462),r=(n(7294),n(3905)),s=n(9960),o=n(5488),i=n(5162);n(7643);const l=n.p+"assets/images/cloudflare_dashboard-0b421fb197496e0a87a3fb8811303d15.png",d=n.p+"assets/images/create_service-ead89209e034962dcfdb35a0b72e911b.png",u=n.p+"assets/images/environment_variables-78d222f2474f8158ea5796b0125aeb4d.png",c=(n.p,n.p+"assets/images/cf_add_vars-360b2d8adc8f6a0c14ebdc658c17e91b.png"),p=n.p+"assets/images/quick_edit-0081c23e3c8dd80ad2d8fed30960a898.png",h=n.p+"assets/images/cf_api_key-48bd409fc5776647520671618af1b854.png",m=n.p+"assets/images/cf_add_code-4c013377aa1a725aa9bbb24d47d89c07.png",k=n.p+"assets/images/cf_send_req-ee09fd00cca2f33cbc967444185fd57f.png",g=n.p+"assets/images/cf_200_response-5bcea9384d2de525b3e32dc9cdf48af3.png";var w=n(2006);const v={title:"Proxy Requests to Figment APIs"},f=void 0,b={unversionedId:"guides/proxy-requests",id:"guides/proxy-requests",title:"Proxy Requests to Figment APIs",description:"This guide will show you how to deploy a proxy using a Cloudflare worker to remove API Keys from your clientside codebase and",source:"@site/docs/guides/proxy-requests.mdx",sourceDirName:"guides",slug:"/guides/proxy-requests",permalink:"/guides/proxy-requests",draft:!1,tags:[],version:"current",frontMatter:{title:"Proxy Requests to Figment APIs"},sidebar:"docsSidebar",previous:{title:"Manage & Secure API Keys",permalink:"/guides/manage-and-secure-api-keys"},next:{title:"Support",permalink:"/support"}},y={},N=[{value:"Motivation",id:"motivation",level:2},{value:"Disclaimer",id:"disclaimer",level:2},{value:"Create a Cloudflare Service Worker",id:"create-a-cloudflare-service-worker",level:2},{value:"Create a Service",id:"create-a-service",level:3},{value:"Add Environment Variables",id:"add-environment-variables",level:3},{value:"Add Proxy Code to Cloudflare Worker",id:"add-proxy-code-to-cloudflare-worker",level:3},{value:"Create a new Worker with Wrangler",id:"create-a-new-worker-with-wrangler",level:4},{value:"Usage",id:"usage",level:2},{value:"Code Explanation",id:"code-explanation",level:2},{value:"Environment Variables",id:"environment-variables",level:3},{value:"Building a Request URL",id:"building-a-request-url",level:3},{value:"Restricted Access",id:"restricted-access",level:3},{value:"CORS Requests",id:"cors-requests",level:3},{value:"Handle WebSocket Connections",id:"handle-websocket-connections",level:3},{value:"Handle HTTP Requests",id:"handle-http-requests",level:3},{value:"addEventListener",id:"addeventlistener",level:3},{value:"Testing and Troubleshooting",id:"testing-and-troubleshooting",level:2},{value:"References",id:"references",level:2}],C={toc:N};function q(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},C,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This guide will show you how to deploy a proxy using a Cloudflare worker to remove API Keys from your clientside codebase and\nprovide a foundational middleware for further security controls.\nThis guide assumes working knowledge of JavaScript and a ",(0,r.kt)(s.Z,{to:"https://cloudflare.com/",mdxType:"Link"},"Cloudflare")," account."),(0,r.kt)("h2",{id:"motivation"},"Motivation"),(0,r.kt)("p",null,"To make use of Figment APIs, calls must be ",(0,r.kt)(s.Z,{to:"/quickstart/api-authentication",mdxType:"Link"},"authenticated using your project's API key"),".\nIn certain instances you may want to make calls from client side applications.\nDoing so directly would mean having the API Key in the client codebase and visible during network requests.\nUsing a proxy means we can take API Key out of the client side.\nIn addition having a middleware means we can take further steps such as validating CORS Origins, implementing an allowlist for IPs, throttling requests and more."),(0,r.kt)("h2",{id:"disclaimer"},"Disclaimer"),(0,r.kt)("p",null,"It's important to maintain awareness of the security considerations for the environment in which you're operating. The code example we've provided in the guide below is an example to get you started and not meant for production out of the box."),(0,r.kt)("admonition",{title:"reminder",type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Always use ",(0,r.kt)(s.Z,{to:"https://en.wikipedia.org/wiki/Transport_Layer_Security",mdxType:"Link"},"Transport Layer Security")," (TLS), meaning ",(0,r.kt)("a",{parentName:"p",href:"https://developers.cloudflare.com/workers/learning/using-websockets/"},(0,r.kt)("strong",{parentName:"a"},"WSS"))," or ",(0,r.kt)("a",{parentName:"p",href:"https://www.cloudflare.com/en-ca/learning/ssl/what-is-https/"},(0,r.kt)("strong",{parentName:"a"},"HTTPS"))," protocols.\nTraffic sent over ",(0,r.kt)("strong",{parentName:"p"},"WS")," or ",(0,r.kt)("strong",{parentName:"p"},"HTTP")," protocols is not secure, regardless of the method used.")),(0,r.kt)("h2",{id:"create-a-cloudflare-service-worker"},"Create a Cloudflare Service Worker"),(0,r.kt)(o.Z,{mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"dashboard",label:"Cloudflare Dashboard",default:!0,mdxType:"TabItem"},(0,r.kt)("h3",{id:"create-a-service"},"Create a Service"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},'From the Workers Overview tab, click the "Create a Service" button.')),(0,r.kt)("img",{src:l,width:"400",alt:"Cloudflare Dashboard",className:"shadow--tl inline-image"}),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},'Give the service a name, then click the "Create service" button.')),(0,r.kt)("img",{src:d,width:"400",alt:"Create a Service",className:"shadow--tl inline-image"}),(0,r.kt)("h3",{id:"add-environment-variables"},"Add Environment Variables"),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"From the Settings tab the worker, add the necessary ",(0,r.kt)("a",{parentName:"li",href:"https://developers.cloudflare.com/workers/platform/environment-variables/#environment-variables-via-the-dashboard"},"environment variables"),".")),(0,r.kt)("img",{src:u,width:"400",alt:"Environment Variables",className:"shadow--tl inline-image"}),(0,r.kt)("p",null,"You'll need:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"API_KEY"),' - Your Figment API Key, click the "Encrypt" button once you\'ve set the value.'),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ALLOWED_ORIGINS")," - A JSON array of all origins that the service should accept calls from e.g. ",(0,r.kt)("inlineCode",{parentName:"li"},'["docs.figment.io", null]'),". Note that providing ",(0,r.kt)("inlineCode",{parentName:"li"},"null")," will allow the service to accept calls without Origin headers e.g. terminal curl request. To disable this feature remove ",(0,r.kt)("inlineCode",{parentName:"li"},"null")," from the array."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"PROXY_HOST")," - The the URL where the worker is deployed e.g. ",(0,r.kt)("inlineCode",{parentName:"li"},"https://proxy.yourusername.workers.dev"),". If you have set up a custom domain in Cloudflare, use that instead.")),(0,r.kt)("img",{src:h,width:"400",alt:"Encrypt the API key",className:"shadow--tl inline-image"}),(0,r.kt)("img",{src:c,width:"400",alt:"Add Other Environment Variables",className:"shadow--tl inline-image"}),(0,r.kt)("h3",{id:"add-proxy-code-to-cloudflare-worker"},"Add Proxy Code to Cloudflare Worker"),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},'Click on the "Quick edit" button, then copy and paste the code from ',(0,r.kt)(s.Z,{to:"#usage",mdxType:"Link"},"the ",(0,r.kt)("strong",{parentName:"li"},"Usage")," section below")," into the Cloudflare code editor on the left side of the page.")),(0,r.kt)("img",{src:p,width:"400",alt:"Quick Edit",className:"shadow--tl inline-image"}),(0,r.kt)("ol",{start:6},(0,r.kt)("li",{parentName:"ol"},"Save and Deploy the code explained below to the worker, making any adjustments required by your specific use case.")),(0,r.kt)("img",{src:m,width:"400",alt:"Save and Deploy",className:"shadow--tl inline-image"})),(0,r.kt)(i.Z,{value:"wrangler",label:"Wrangler CLI",mdxType:"TabItem"},(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Check out the Cloudflare guide ",(0,r.kt)(s.Z,{to:"https://developers.cloudflare.com/workers/wrangler/get-started/",mdxType:"Link"},"Get Started with Wrangler")," for more information about the Wrangler CLI.")),(0,r.kt)("p",null,"You can install Wrangler with the command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"npm install -g wrangler\n")),(0,r.kt)("br",null),(0,r.kt)("h4",{id:"create-a-new-worker-with-wrangler"},"Create a new Worker with Wrangler"),(0,r.kt)("p",null,"First, create a new directory to contain your project:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir api-proxy && cd api-proxy\n")),(0,r.kt)("p",null,"This command will generate a ",(0,r.kt)("inlineCode",{parentName:"p"},"wrangler.toml")," file and the code for a Fetch or Scheduled handler in the current directory:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"wrangler init\n")),(0,r.kt)("p",null,"Follow the prompts, and then you will be able to edit the Worker code in the ",(0,r.kt)("inlineCode",{parentName:"p"},"src")," directory."),(0,r.kt)("p",null,"When you are ready, replace the code in ",(0,r.kt)("inlineCode",{parentName:"p"},"src/index.js")," with the sample code we've provided in the ",(0,r.kt)(s.Z,{to:"#usage",mdxType:"Link"},"Usage")," section."),(0,r.kt)("admonition",{title:"important",type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"The Worker code will be in ",(0,r.kt)("inlineCode",{parentName:"p"},"src/index.ts")," if you chose to use TypeScript when creating the Worker.")))),(0,r.kt)("h2",{id:"usage"},"Usage"),(0,r.kt)("p",null,"For any Figment API and network to which you want to send a proxied request, you would need to add the hostname to that value in ",(0,r.kt)("inlineCode",{parentName:"p"},"env.HOSTS")," in the Worker code.\nThe values for protocols, networks and services in ",(0,r.kt)("inlineCode",{parentName:"p"},"HOSTS")," can be constructed as follows:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The protocol will be either ",(0,r.kt)("inlineCode",{parentName:"li"},"wss")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"https"),". ",(0,r.kt)("em",{parentName:"li"},"Not all networks or API endpoints offer WebSocket support"),"."),(0,r.kt)("li",{parentName:"ul"},"Check the ",(0,r.kt)(s.Z,{to:"/api-reference/",mdxType:"Link"},"API Reference table"),", which shows the APIs supported by each network.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"The APIs are referred to in the code by the variable ",(0,r.kt)("inlineCode",{parentName:"li"},"services"),"."))),(0,r.kt)("li",{parentName:"ul"},"The keys to use can be taken directly from the Figment docs URL: ",(0,r.kt)("inlineCode",{parentName:"li"},"https://docs.figment.io/api-reference/node-api/ethereum"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"The service is ",(0,r.kt)("inlineCode",{parentName:"li"},"node-api"),"."),(0,r.kt)("li",{parentName:"ul"},"The network (in this example) is ",(0,r.kt)("inlineCode",{parentName:"li"},"ethereum"),", so the value would be the hostname of the endpoint to which you are proxying the request.")))),(0,r.kt)("p",null,"The highlighted lines indicate where these values go in ",(0,r.kt)("inlineCode",{parentName:"p"},"env.HOSTS"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript",metastring:"{2,3,5,9,10,12}","{2,3,5,9,10,12}":!0},'HOSTS: {\n    wss: {\n      "node-api": {\n        ...\n        ethereum: "ethereum-mainnet-websocket-endpoint.figment.io",\n        ...\n      },\n    },\n    https: {\n      "node-api": {\n        ...\n        ethereum: "ethereum-mainnet-jsonrpc-endpoint.figment.io",\n        ...\n      },\n      ...\n    }\n}\n')),(0,r.kt)("p",null,"The hostnames for Figment's API endpoints are available via the user dashboard when viewing a protocol.\nSimply copy and paste the appropriate value from the user dashboard."),(0,r.kt)("admonition",{title:"important",type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Remember that the hostname does not include the protocol, ",(0,r.kt)("inlineCode",{parentName:"p"},"wss://")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"https://"),".")),(0,r.kt)("img",{src:w.Z,width:"400",alt:"Figment Dashboard - Hostnames",className:"shadow--tl inline-image"}),(0,r.kt)("admonition",{title:"important",type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Code examples provided as samples only and should not be used in production out of the box. Use at your own risk.")),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("details",null,(0,r.kt)("summary",null,"Click here to view the complete example proxy, \u2248200 lines of code."),(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-js"},'const env = {\n  API_KEY: API_KEY,\n  ALLOWED_ORIGINS: JSON.parse(ALLOWED_ORIGINS),\n  PROXY_HOST: PROXY_HOST,\n  ALLOWED_METHODS: ["POST", "GET", "OPTIONS"],\n  HOSTS: {\n    wss: {\n      "node-api": {\n        arbitrum: "",\n        bnb: "",\n        celo: "",\n        "cosmos-tendermint-rpc": "",\n        ethereum: "",\n        fantom: "",\n        kusama: "",\n        optimism: "",\n        "osmosis-tendermint-rpc": "",\n        polkadot: "",\n        polygon: "",\n        solana: "",\n      },\n    },\n    https: {\n      "node-api": {\n        arbitrum: "",\n        "avalanche-c-chain": "",\n        "avalanche-p-chain": "",\n        "avalanche-x-chain": "",\n        bnb: "",\n        celo: "",\n        "cosmos-lcd": "",\n        "cosmos-tendermint-rpc": "",\n        ethereum: "",\n        fantom: "",\n        "kusama-sidecar": "",\n        "mina-graphql": "",\n        near: "",\n        optimism: "",\n        "osmosis-lcd": "",\n        "osmosis-tendermint-rpc": "",\n        "polkadot-sidecar": "",\n        polygon: "",\n        solana: "",\n      },\n      "rewards-api": {\n        ethereum: "",\n        polkadot: "",\n        solana: "",\n        near: "",\n      },\n      "rewards-rates-api": {\n        ethereum: "",\n        polkadot: "",\n        solana: "",\n      },\n      "transaction-search-api": {\n        avalanche: "",\n        "near-protocol": "",\n      },\n      "staking-api": {\n        avalanche: "",\n        ethereum: "",\n        near: "",\n        polkadot: "",\n        solana: "",\n      },\n      "staking-api-webhooks": {\n        avalanche: "",\n        ethereum: "",\n        near: "",\n        polkadot: "",\n        solana: "",\n      },\n    },\n  },\n};\n\n/**\n * Builds and returns the URL for the node request\n * @param {Request} request - inbount request\n * @throws {Response} 500 error if network isn\'t found\n * @returns {URL} of the node endpoint\n */\nfunction buildURL(request) {\n  const [base, service, network, ...routes] =\n    request.url.split(/(?<!\\/)\\/(?!\\/)/g);\n\n  const protocol =\n    request.headers.get("Upgrade") === "websocket" ? "wss" : "https";\n  const services = env.HOSTS[protocol][service];\n  const url = services ? services[network] : null;\n  if (!url) {\n    throw new Response(\n      `service \'${service}\' for network \'${network}\' could not be found`,\n      {\n        status: 500,\n        statusText: `Invalid network`,\n      }\n    );\n  }\n  return new URL(\n    `${protocol}://${url}/apikey/${env.API_KEY}/${routes.join("/")}`\n  );\n}\n\n/**\n * Ensures the request is authorized to proceed\n * @param {Request} request - inbound request\n * @throws {Response} 403 or 405 if unauthorized\n */\nfunction ensureAuthorized(request) {\n  let error;\n\n  if (!env.ALLOWED_ORIGINS.includes(request.headers.get("Origin"))) {\n    error = {\n      message: `Origin ${request.headers.get("Origin")} not allowed`,\n      status: 405,\n      statusText: "Not Allowed",\n    };\n  } else if (!env.ALLOWED_METHODS.includes(request.method)) {\n    error = {\n      message: `Method ${request.method} not allowed`,\n      status: 405,\n      statusText: "Not Allowed",\n    };\n  } else if (\n    request.method !== "OPTIONS" &&\n    request.headers.get("Authorization") !== env.API_KEY\n  ) {\n    error = {\n      message: `Not Authorized ${request.method}!`,\n      status: 403,\n      statusText: "Not Allowed",\n    };\n  }\n\n  if (error) {\n    throw new Response(error.message, {\n      status: 403,\n      statusText: `Not Allowed`,\n    });\n  }\n}\n\n/**\n * Builds and returns preflight response based on request\n * @param {Request} request - inbound request\n * @returns {Response} with required CORS params\n */\nfunction getPreflightResponse(request) {\n  return new Response(null, {\n    status: 200,\n    headers: {\n      "Access-Control-Allow-Headers":\n        request.headers.get("Access-Control-Request-Headers") || "",\n      "Access-Control-Allow-Origin": request.headers.get("Origin") || "",\n      "Access-Control-Allow-Methods": env.ALLOWED_METHODS.join(","),\n      "Access-Control-Max-Age": "86400",\n    },\n  });\n}\n\n/**\n * Establishes a websocket connection and returns response containing ws client\n * @param {string} url - the figment api url\n * @throws {Response} relays status and statusText if connection fails\n * @returns {Response} with required websocket client\n */\nasync function getWebsocketConnection(url) {\n  const result = await fetch(url, {\n    headers: {\n      Upgrade: "websocket",\n      Authorization: env.API_KEY,\n    },\n  });\n\n  // https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/101\n  if (result.status !== 101) {\n    throw new Response(null, {\n      status: result.status,\n      statusText: result.statusText,\n    });\n  }\n\n  // Accept the websocket connection\n  const websocket = result.webSocket;\n  websocket.accept();\n\n  // Create a client/server to act as the proxy layer\n  const clientServerPair = new WebSocketPair();\n  const [client, server] = Object.values(clientServerPair);\n\n  // Tell the Workers runtime to listen for WebSocket data & keep the connection open\n  server.accept();\n\n  // Any messages from the client are forwarded to the DataHub socket\n  server.addEventListener("message", (event) => {\n    websocket.send(event.data);\n  });\n\n  // Any messages coming from DataHub are forwarded back to the client\n  websocket.addEventListener("message", (event) => {\n    server.send(event.data);\n  });\n\n  return new Response(null, {\n    status: 101,\n    webSocket: client,\n  });\n}\n\n/**\n * Fetches results from Figment APIs and returns result\n * @param {string} url - the figment api url\n * @param {Request} request - inbound request\n * @returns {Response} relays Figment API node response\n */\nasync function getRpcResponse(url, request) {\n  const apiRequest = new Request(url, request);\n  apiRequest.headers.set("origin", `https://${env.PROXY_HOST}`);\n\n  // Create then rebuild a new response from the API result so it\'s mutable\n  let response = await fetch(apiRequest);\n  response = new Response(response.body, response);\n  response.headers.set(\n    "Access-Control-Allow-Headers",\n    request.headers.get("Access-Control-Request-Headers") || ""\n  );\n  response.headers.set(\n    "Access-Control-Allow-Origin",\n    request.headers.get("Origin") || ""\n  );\n  response.headers.set(\n    "Access-Control-Allow-Methods",\n    env.ALLOWED_METHODS.join(",")\n  );\n  return response;\n}\n\n// Main function to process the incoming fetch request\naddEventListener("fetch", function handleFetch(event) {\n  try {\n    const { request } = event;\n    const url = buildURL(request);\n    ensureAuthorized(request);\n    if (request.method === "OPTIONS") {\n      event.respondWith(getPreflightResponse(request));\n    } else if (request.headers.get("Upgrade") === "websocket") {\n      event.respondWith(getWebsocketConnection(url));\n    } else {\n      event.respondWith(getRpcResponse(url, request));\n    }\n  } catch (error) {\n    event.respondWith(error);\n  }\n});\n')))),(0,r.kt)("p",null,"You're all set to make requests to Figment APIs and pass responses back to the client without exposing your API keys!\nTo make calls with the proxy, formulate your ",(0,r.kt)("inlineCode",{parentName:"p"},"URL")," using ",(0,r.kt)("inlineCode",{parentName:"p"},"<proxy-url>/<service>/<network>")," followed by any query parameters\njust as with the Figment API calls."),(0,r.kt)("p",null,"Here are some examples using the JavaScript fetch API, given the proxy ",(0,r.kt)("inlineCode",{parentName:"p"},"http://api-proxy.username.workers.dev"),":"),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Fetch Ethereum gas price from Node API"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'fetch("http://api-proxy.username.workers.dev/node-api/ethereum", {\n  method: "POST",\n  headers: { "Content-Type": "application/json" },\n  body: JSON.stringify({\n    jsonrpc: "2.0",\n    method: "eth_gasPrice",\n    params: [],\n    id: 1,\n  }),\n});\n'))),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Fetch Ethereum rewards for a Validator from Rewards API"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'fetch("http://api-proxy.username.workers.dev/rewards-api/ethereum", {\n  method: "POST",\n  headers: { "Content-Type": "application/json" },\n  body: JSON.stringify({\n    network: "ethereum",\n    accounts: [\n      "0x8914b656ad92ffd6ad2920f8f2ad186b0502e4848ad5c5451fea01e42898a2ea07009afb5ca0fd20119da155d745a299",\n    ],\n    start: 151759,\n    end: 151760,\n  }),\n});\n'))),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Fetch Avalanche transactions from Transaction Search API"),(0,r.kt)("admonition",{title:"important",type:"caution"},(0,r.kt)("p",{parentName:"admonition"},(0,r.kt)("inlineCode",{parentName:"p"},"GET")," requests supply the query parameters in the request URL. There is no request body.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'fetch(\n  "http://api-proxy.username.workers.dev/transaction-search-api/avalanche/transactions?network=avalanche&chain_ids=mainnet&start_height=1921984&address=avax1pvkhyf0y9674p2ps40vmp0a8w427384lpr8zan,avax1rlu93pnalclt7h0dte3evua97lv4fp4qzax5wq",\n  {\n    method: "GET",\n  }\n);\n'))),(0,r.kt)("p",null,"Continue with the explanation below, or proceed to the ",(0,r.kt)(s.Z,{to:"#testing-and-troubleshooting",mdxType:"Link"},"Testing and Troubleshooting")," section."),(0,r.kt)("h2",{id:"code-explanation"},"Code Explanation"),(0,r.kt)("h3",{id:"environment-variables"},"Environment Variables"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"env")," constant contains the values of the Cloudflare environment variables ",(0,r.kt)("inlineCode",{parentName:"p"},"API_KEY"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"ALLOWED_ORIGINS"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"PROXY_ORIGIN")," as well as a list of ",(0,r.kt)("inlineCode",{parentName:"p"},"ALLOWED_METHODS")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"HOSTS"),"."),(0,r.kt)("p",null,"It is also useful to define hostnames for the Figment API endpoints to which we would be sending requests, separated by their protocol ","\u2014"," either WebSocket Secure (",(0,r.kt)("inlineCode",{parentName:"p"},"wss"),") or SSL (",(0,r.kt)("inlineCode",{parentName:"p"},"https"),")."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"HOSTS")," separates ",(0,r.kt)("inlineCode",{parentName:"p"},"wss")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"https")," hostnames, and places them into each applicable service. Figment provides access to infrastructure as well as APIs. One such API is the Node API, allowing clients to communicate directly with Proof-of-Stake networks."),(0,r.kt)("p",null,"Thus, ",(0,r.kt)("inlineCode",{parentName:"p"},"env.HOSTS['wss']['node-api'][0]")," would refer to the Arbitrum hostname, which is where clients send their requests to the Arbitrum Node API."),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Click here to view the code."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js",metastring:'{2,3,4,5,6} title="Note: ... indicates where values were removed for display"',"{2,3,4,5,6}":!0,title:'"Note:',"...":!0,indicates:!0,where:!0,values:!0,were:!0,removed:!0,for:!0,'display"':!0},'const env = {\n  API_KEY: API_KEY,\n  ALLOWED_ORIGINS: JSON.parse(ALLOWED_ORIGINS),\n  PROXY_HOST: PROXY_HOST,\n  ALLOWED_METHODS: ["POST", "GET", "OPTIONS"],\n  HOSTS: {\n    "wss": {\n      "node-api": {\n        "arbitrum": "arbitrum-mainnet-ws-archive-dbgtxn.datahub.figment.io",\n        ...\n      }\n      ...\n    },\n    "https": {\n      "node-api": {\n        "arbitrum": "arbitrum-mainnet-rpc-archive-dbgtxn.datahub.figment.io",\n        ...\n      }\n      ...\n    },\n  },\n};\n'))),(0,r.kt)("h3",{id:"building-a-request-url"},"Building a Request URL"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"buildURL")," processes an inbound request, returning the completed URL to be queried. This will be the Figment API endpoint, including the route."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"protocol")," in this scope will be ",(0,r.kt)("inlineCode",{parentName:"li"},"wss")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"https"),". Based on the presence of an ",(0,r.kt)("inlineCode",{parentName:"li"},"Upgrade")," header, we know if the incoming connection is requesting to be upgraded to a WebSocket. Each protocol is handled separately."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"services")," in this scope will be one of the defined keys in ",(0,r.kt)("inlineCode",{parentName:"li"},"HOSTS"),", assigned to either protocol ","\u2014"," ex. ",(0,r.kt)("inlineCode",{parentName:"li"},"node-api")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"routes")," are passed via the request URL, they indicate which Figment API endpoint to query. For example, ",(0,r.kt)("inlineCode",{parentName:"li"},"/node-api/solana")," would direct the request to the ",(0,r.kt)("inlineCode",{parentName:"li"},"HOSTS")," value for that service and network.")),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Click here to view the code."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'/**\n * Builds and returns the URL for the node request\n * @param {Request} request - inbount request\n * @throws {Response} 500 error if network isn\'t found\n * @returns {URL} of the node endpoint\n */\nfunction buildURL(request) {\n  const [base, service, network, ...routes] =\n    request.url.split(/(?<!\\/)\\/(?!\\/)/g);\n\n  const protocol =\n    request.headers.get("Upgrade") === "websocket" ? "wss" : "https";\n  const services = env.HOSTS[protocol][service];\n  const url = services ? services[network] : null;\n  if (!url) {\n    throw new Response(\n      `service \'${service}\' for network \'${network}\' could not be found`,\n      {\n        status: 500,\n        statusText: `Invalid network`,\n      }\n    );\n  }\n  return new URL(\n    `${protocol}://${url}/apikey/${env.API_KEY}/${routes.join("/")}`\n  );\n}\n'))),(0,r.kt)("h3",{id:"restricted-access"},"Restricted Access"),(0,r.kt)("p",null,"We want to restrict access to the proxy to ",(0,r.kt)("inlineCode",{parentName:"p"},"Origins")," and methods which are explicitly allowed.\nIf the request does not meet these criteria, or if there is an error, we will respond to the request with the appropriate ",(0,r.kt)(s.Z,{to:"/guides/response-codes-and-error-codes",mdxType:"Link"},(0,r.kt)("inlineCode",{parentName:"p"},"4xx")," status codes"),"."),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Click here to view the code."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'/**\n * Ensures the request is authorized to proceed\n * @param {Request} request - inbound request\n * @throws {Response} 403 or 405 if unauthorized\n */\nfunction ensureAuthorized(request) {\n  let error;\n\n  if (!env.ALLOWED_ORIGINS.includes(request.headers.get("Origin"))) {\n    error = {\n      message: `Origin ${request.headers.get("Origin")} not allowed`,\n      status: 405,\n      statusText: "Not Allowed",\n    };\n  } else if (!env.ALLOWED_METHODS.includes(request.method)) {\n    error = {\n      message: `Method ${request.method} not allowed`,\n      status: 405,\n      statusText: "Not Allowed",\n    };\n  } else if (\n    request.method !== "OPTIONS" &&\n    request.headers.get("Authorization") !== env.API_KEY\n  ) {\n    error = {\n      message: `Not Authorized ${request.method}!`,\n      status: 403,\n      statusText: "Not Allowed",\n    };\n  }\n\n  if (error) {\n    throw new Response(error.message, {\n      status: 403,\n      statusText: `Not Allowed`,\n    });\n  }\n}\n'))),(0,r.kt)("h3",{id:"cors-requests"},"CORS Requests"),(0,r.kt)("p",null,"Handle ",(0,r.kt)("strong",{parentName:"p"},"C"),"ross ",(0,r.kt)("strong",{parentName:"p"},"O"),"rigin ",(0,r.kt)("strong",{parentName:"p"},"R"),"esource ",(0,r.kt)("strong",{parentName:"p"},"S"),"haring (CORS) requests by responding with the appropriate headers."),(0,r.kt)("p",null,"All CORS preflight requests use the ",(0,r.kt)("inlineCode",{parentName:"p"},"OPTIONS")," method but not all ",(0,r.kt)("inlineCode",{parentName:"p"},"OPTIONS")," requests are CORS preflight requests."),(0,r.kt)("p",null,"What this means in practice is that we must treat all ",(0,r.kt)("inlineCode",{parentName:"p"},"OPTIONS")," requests as CORS preflight requests."),(0,r.kt)("p",null,"CORS Resources:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)(s.Z,{to:"/quickstart/settings-and-security#app-security-settings",mdxType:"Link"},"Quick Start: Settings and Security")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)(s.Z,{to:"/guides/troubleshoot-cors-errors",mdxType:"Link"},"Troubleshooting CORS Errors"))),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Click here to view the code."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'/**\n * Builds and returns preflight response based on request\n * @param {Request} request - inbound request\n * @returns {Response} with required CORS params\n */\nfunction getPreflightResponse(request) {\n  return new Response(null, {\n    status: 200,\n    headers: {\n      "Access-Control-Allow-Headers":\n        request.headers.get("Access-Control-Request-Headers") || "",\n      "Access-Control-Allow-Origin": request.headers.get("Origin") || "",\n      "Access-Control-Allow-Methods": env.ALLOWED_METHODS.join(","),\n      "Access-Control-Max-Age": "86400",\n    },\n  });\n}\n'))),(0,r.kt)("h3",{id:"handle-websocket-connections"},"Handle WebSocket Connections"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"getWebsocketConnection")," handles WebSocket traffic by upgrading the connection, accepting the request, creating a client/server pair, and then ",(0,r.kt)("inlineCode",{parentName:"p"},"addEventListener")," can pass the messages between the client and server.\nA successful response must always return status code ",(0,r.kt)("inlineCode",{parentName:"p"},"101 Switching Protocols"),". Read more about the status code, WebSockets and WebSocket security in the ",(0,r.kt)(s.Z,{to:"#references",mdxType:"Link"},"Reference section")," at the end of the guide."),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Click here to view the code."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'/**\n * Establishes a websocket connection and returns response containing ws client\n * @param {string} url - the figment api url\n * @throws {Response} relays status and statusText if connection fails\n * @returns {Response} with required websocket client\n */\nasync function getWebsocketConnection(url) {\n  const result = await fetch(url, {\n    headers: {\n      Upgrade: "websocket",\n      Authorization: env.API_KEY,\n    },\n  });\n\n  // https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/101\n  if (result.status !== 101) {\n    throw new Response(null, {\n      status: result.status,\n      statusText: result.statusText,\n    });\n  }\n\n  // Accept the websocket connection\n  const websocket = result.webSocket;\n  websocket.accept();\n\n  // Create a client/server to act as the proxy layer\n  const clientServerPair = new WebSocketPair();\n  const [client, server] = Object.values(clientServerPair);\n\n  // Tell the Workers runtime to listen for WebSocket data & keep the connection open\n  server.accept();\n\n  // Any messages from the client are forwarded to the DataHub socket\n  server.addEventListener("message", (event) => {\n    websocket.send(event.data);\n  });\n\n  // Any messages coming from DataHub are forwarded back to the client\n  websocket.addEventListener("message", (event) => {\n    server.send(event.data);\n  });\n\n  return new Response(null, {\n    status: 101,\n    webSocket: client,\n  });\n}\n'))),(0,r.kt)("h3",{id:"handle-http-requests"},"Handle HTTP Requests"),(0,r.kt)("p",null,"This function uses the ",(0,r.kt)("inlineCode",{parentName:"p"},"fetch")," API after setting the ",(0,r.kt)("inlineCode",{parentName:"p"},"Authorization")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"Origin")," headers.\nThis is a naive implementation, though it is effective when all you want to do is keep your API key secure.\nFrom the client point of view, the API key is never visible."),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Click here to view the code."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'/**\n * Fetches results from Figment APIs and returns result\n * @param {string} url - the figment api url\n * @param {Request} request - inbound request\n * @returns {Response} relays Figment API node response\n */\nasync function getRpcResponse(url, request) {\n  const apiRequest = new Request(url, request);\n  apiRequest.headers.set("origin", `https://${env.PROXY_HOST}`);\n\n  // Create then rebuild a new response from the API result so it\'s mutable\n  let response = await fetch(apiRequest);\n  response = new Response(response.body, response);\n  response.headers.set(\n    "Access-Control-Allow-Headers",\n    request.headers.get("Access-Control-Request-Headers") || ""\n  );\n  response.headers.set(\n    "Access-Control-Allow-Origin",\n    request.headers.get("Origin") || ""\n  );\n  response.headers.set(\n    "Access-Control-Allow-Methods",\n    env.ALLOWED_METHODS.join(",")\n  );\n  return response;\n}\n'))),(0,r.kt)("h3",{id:"addeventlistener"},"addEventListener"),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"The ",(0,r.kt)("inlineCode",{parentName:"p"},"addEventListener")," function defines triggers for a Worker script to execute."),(0,r.kt)("p",{parentName:"admonition"},"Read more about the ",(0,r.kt)("a",{parentName:"p",href:"https://developers.cloudflare.com/workers/runtime-apis/fetch/"},"fetch API")," and ",(0,r.kt)("a",{parentName:"p",href:"https://developers.cloudflare.com/workers/runtime-apis/add-event-listener/"},(0,r.kt)("inlineCode",{parentName:"a"},"addEventListener"))," in the Cloudflare documentation.")),(0,r.kt)("p",null,"In this case we want to tie all of the functionality together, ensuring requests are handled with the appropriate function. The ",(0,r.kt)("inlineCode",{parentName:"p"},"try"),"/",(0,r.kt)("inlineCode",{parentName:"p"},"catch")," block here is necessary to pass along any errors that occur."),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Click here to view the code."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'/**\n * addEventListener is the Service Worker entrypoint.\n * @param {string} - fetch\n * @param {callback} - A named function to handle the event\n */\naddEventListener("fetch", function handleFetch(event) {\n  try {\n    const { request } = event;\n    const url = buildURL(request);\n    ensureAuthorized(request);\n    if (request.method === "OPTIONS") {\n      event.respondWith(getPreflightResponse(request));\n    } else if (request.headers.get("Upgrade") === "websocket") {\n      event.respondWith(getWebsocketConnection(url));\n    } else {\n      event.respondWith(getRpcResponse(url, request));\n    }\n  } catch (error) {\n    event.respondWith(error);\n  }\n});\n'))),(0,r.kt)("br",null),(0,r.kt)("h2",{id:"testing-and-troubleshooting"},"Testing and Troubleshooting"),(0,r.kt)("p",null,"In the Cloudflare worker's quick edit view, you can send various HTTP requests directly to the proxy URL.\nTo verify that the proxy is working with your application:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Ensure that you have set your deployed app's hostname in the ",(0,r.kt)("inlineCode",{parentName:"li"},"ALLOWED_ORIGINS")," environment variable."),(0,r.kt)("li",{parentName:"ol"},"Also ensure the deployed proxy worker's URL is set in the ",(0,r.kt)("inlineCode",{parentName:"li"},"PROXY_ORIGIN")," environment variable."),(0,r.kt)("li",{parentName:"ol"},"Send a request to the proxy in Cloudflare:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"If you change the HTTP method in the Cloudflare Service Worker to ",(0,r.kt)("inlineCode",{parentName:"li"},"POST"),", remember to also add a ",(0,r.kt)("inlineCode",{parentName:"li"},"Content-Type")," header with a value of ",(0,r.kt)("inlineCode",{parentName:"li"},"application/json"),"."),(0,r.kt)("li",{parentName:"ul"},"To get the current block height of Solana for example, append the service and network (",(0,r.kt)("inlineCode",{parentName:"li"},"/node-api/solana"),") to the request URL."))),(0,r.kt)("li",{parentName:"ol"},"Check the response. Status ",(0,r.kt)("inlineCode",{parentName:"li"},"200")," and the expected response from the requested method indicate that all is working as intended.")),(0,r.kt)("img",{src:k,width:"400",alt:"Send a Request From Cloudflare",className:"shadow--tl inline-image"}),(0,r.kt)("img",{src:g,width:"400",alt:"Figment API Response via Cloudflare Proxy",className:"shadow--tl inline-image"}),(0,r.kt)("h2",{id:"references"},"References"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"*"," ",(0,r.kt)("a",{parentName:"li",href:"https://blog.cloudflare.com/introducing-cloudflare-workers/"},"Cloudflare Blog: Introducing Cloudflare Workers")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.tim-kleyersburg.de/articles/api-proxy-with-cloudflare-workers/"},"Tim Kleyersburg: Create an API proxy with Cloudflare Workers")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/101"},"MDN Docs: HTTP Status 101")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://portswigger.net/web-security/websockets/what-are-websockets"},"PortSwigger Web Security Academy: What are WebSockets?")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://brightsec.com/blog/websocket-security-top-vulnerabilities/"},"Bright AppSec Blog: WebSocket Security"))),(0,r.kt)("p",null,"You should now have everything you need in order to successfully implement a proxy as a serverless function. Happy building!"))}q.isMDXComponent=!0},2006:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/endpoint_example-9ae8949e37923b110ea0961e1d886dbb.png"}}]);